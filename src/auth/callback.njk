---
layout: layouts/base.njk  # Herda o template base
permalink: auth/callback/
---

<script>
  (async function() {
    try {
      // 1. Inicialização garantida
      const supabase = window.supabaseClient.init();
      
      // 2. Processamento do callback OAuth
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      
      // 3. Validação dos tokens
      if (!params.get('access_token')) {
        throw new Error('Token de acesso não encontrado na URL');
      }

      // 4. Configuração da sessão
      const { error } = await supabase.auth.setSession({
        access_token: params.get('access_token'),
        refresh_token: params.get('refresh_token')
      });

      if (error) throw error;
      
      // 5. Redirecionamento seguro
      window.location.replace('/dashboard'); // Evita histórico de navegação
      
    } catch (error) {
      console.error('Erro no processamento:', error);
      window.location.replace('/auth/login?error=' + 
        encodeURIComponent(error.message));
    }
  })();
</script>